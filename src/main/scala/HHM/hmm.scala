package HHM

import breeze.linalg.{DenseMatrix, DenseVector, sum}
import scala.collection.mutable.ListBuffer

/**
 *
 * @param pi                    éšçŠ¶æ€åˆå§‹æ¦‚ç‡åˆ†å¸ƒ
 * @param stateTransitionMatrix çŠ¶æ€è½¬ç§»çŸ©é˜µ
 * @param confusionMatrix       è§‚æµ‹çŠ¶æ€ç”ŸæˆçŸ©é˜µ
 */
case class hmm(
                pi: DenseVector[Double],
                stateTransitionMatrix: DenseMatrix[Double],
                confusionMatrix: DenseMatrix[Double]
              ) {
  // çŠ¶æ€é›†åˆä¸ªæ•°
  val n: Int = stateTransitionMatrix.cols

  // æ ¹æ®ç»™å®šçš„æ¦‚ç‡åˆ†å¸ƒéšæœºè¿”å›æ•°æ®
  def getDistData(dist: DenseVector[Double]): Int = {
    var initState: Int = 0
    for (i <- 0 until dist.length) {
      if (math.random <= dist.slice(0, i).toArray.sum) {
        initState = i
        return initState
      }
    }
    initState
  }

  //   æ ¹æ®ç»™å®šçš„å‚æ•°ç”Ÿæˆè§‚æµ‹åºåˆ—
  def generate(t: Int): Array[Int] = {
    //  require(true)
    // æ ¹æ®åˆè¯•æ¦‚è§ˆå‘é‡éšæœºç”Ÿæˆåˆå§‹çŠ¶æ€
    val initState: Int = getDistData(pi)
    // ç”Ÿæˆç¬¬ä¸€ä¸ªè§‚æµ‹
    val inner = confusionMatrix(initState, ::).inner
    val initData: Int = getDistData(inner)

    //ç”Ÿæˆä½™ä¸‹çš„çŠ¶æ€å’Œåºåˆ—
    val datas = new ListBuffer[Int]
    datas.append(initData)

    for (i <- 1 until t) {
      val st = getDistData(stateTransitionMatrix(initState, ::).inner)
      datas append getDistData(confusionMatrix(st, ::).inner)

    }
    datas.toArray

  }


  /**
   * å‰å‘ç®—æ³•
   *
   * @param o è§‚æµ‹åºåˆ—                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              è§‚æµ‹åºåˆ—
   * @return äº§ç”Ÿè§‚æµ‹åºåˆ—çš„æ¦‚ç‡
   */
  def forwardAlgorithm(o: DenseVector[Int]) = {

    val alphat = new ListBuffer[DenseVector[Double]]()

    // Step1 è®¡ç®—åˆå€¼   Î±(i)=Ï€iâˆ—b(i)(ğ‘‚(1))
    // è·å–ç¬¬ä¸€ä¸ªè§‚æµ‹çš„æ¦‚ç‡åˆ†å¸ƒ
    val alpha1i = confusionMatrix(::, o(0)) * pi
    alphat.append(alpha1i)
    //Î±(t)(i)= [âˆ‘ Î±(t-1)(i) a(j)(i)]*b(i)(o(t-1))
    for (t <- 1 until o.length) { // è§‚æµ‹åºåˆ—é•¿åº¦T
      val alphati = new ListBuffer[Double]()
      for (i <- 0 until n) {

        val bit = confusionMatrix(i, o(t))
        val aji = stateTransitionMatrix(::, i)

        alphati.append((alphat(t - 1) * aji).toArray.map(_ * bit).sum)

      }
      alphat.append(DenseVector(alphati.toArray))
    }
    // step3 ç»ˆæ­¢è®¡ç®—(æ¦‚ç‡)ï¼šğ‘ƒ(ğ‘‚|ğœ†)=âˆ‘ a(t)(i)
    alphat(n - 1).toArray.sum
  }

  /**
   * åå‘ç®—æ³•
   *
   * @param o è§‚æµ‹åºåˆ—                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              è§‚æµ‹åºåˆ—
   * @return äº§ç”Ÿè§‚æµ‹åºåˆ—çš„æ¦‚ç‡
   */
  def backwardAlgorithm(o: DenseVector[Int]) = {

    //   Î²T(i) = 1, i=1,2,â€¦â€¦N
    var betati: DenseVector[Double] = DenseVector(Array.fill(n)(1.0))

    //    Î²t(i) = âˆ‘ a(i)(j)b(j)(o(t+1))Î²(t+1)(j)
    for (t <- 1 until o.length reverse) {
      println("betati:" + betati)

      val beat = new ListBuffer[Double]()
      for (i <- 0 until n) {
        val aij = stateTransitionMatrix(i, ::).inner
        val bjT = confusionMatrix(::, o(t))
        sum (aij * bjT * betati )
        beat.append(  sum (aij * bjT * betati ))
      }
      betati = DenseVector(beat.toArray)
    }
    sum (pi * confusionMatrix(::, o(0)) * betati)

  }


}


object hmm {


  def main(args: Array[String]): Unit = {

    val pi = DenseVector(Array(0.2, 0.4, 0.4))

    val stateTransitionMatrix = DenseMatrix((0.5, 0.2, 0.3), (0.3, 0.5, 0.2), (0.2, 0.3, 0.5))

    val confusionMatrix = DenseMatrix((0.5, 0.5), (0.4, 0.6), (0.7, 0.3))

    val o = DenseVector(Array(0, 1, 0))

    val hmmModel = hmm(pi, stateTransitionMatrix, confusionMatrix)

    val doubles = hmmModel.forwardAlgorithm(o)
    val doubles2 = hmmModel.backwardAlgorithm(o)
    println(doubles)
    println(doubles2)

  }

}