package CH10_HHM

import breeze.linalg.{DenseMatrix, DenseVector, sum}
import scala.collection.mutable.ListBuffer

/**
 *
 * @param pi                    隐状态初始概率分布
 * @param stateTransitionMatrix 状态转移矩阵
 * @param confusionMatrix       观测状态生成矩阵
 */
case class hmm(
                pi: DenseVector[Double],
                stateTransitionMatrix: DenseMatrix[Double],
                confusionMatrix: DenseMatrix[Double]
              ) {
  // 状态集合个数
  val n: Int = stateTransitionMatrix.cols

  // 根据给定的概率分布随机返回数据
  def getDistData(dist: DenseVector[Double]): Int = {
    var initState: Int = 0
    for (i <- 0 until dist.length) {
      if (math.random <= dist.slice(0, i).toArray.sum) {
        initState = i
        return initState
      }
    }
    initState
  }

  //   根据给定的参数生成观测序列
  def generate(t: Int): Array[Int] = {
    //  require(true)
    // 根据初试概览向量随机生成初始状态
    val initState: Int = getDistData(pi)
    // 生成第一个观测
    val inner = confusionMatrix(initState, ::).inner
    val initData: Int = getDistData(inner)

    //生成余下的状态和序列
    val datas = new ListBuffer[Int]
    datas.append(initData)

    for (i <- 1 until t) {
      val st = getDistData(stateTransitionMatrix(initState, ::).inner)
      datas append getDistData(confusionMatrix(st, ::).inner)

    }
    datas.toArray

  }


  /**
   * 前向算法
   *
   * @param o 观测序列                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              观测序列
   * @return 产生观测序列的概率
   */
  def forwardAlgorithm(o: DenseVector[Int]) = {

    // 计算初值   α1(i)=πi∗b(i)(𝑂(1))
    var alphati = confusionMatrix(::, o(0)) * pi

    //α(t+1)(i)= [∑ α(t)(j) a(j)(i)]*b(i)(o(t+1))
    for (t <- 1 until o.length) {

      val bit = confusionMatrix(::, o(t))
      val dlt = new ListBuffer[Double]()
      for (j <- 0 until n) {
        val aji = stateTransitionMatrix(::, j)
        dlt.append(sum(alphati * aji))
      }

      alphati = DenseVector(dlt.toArray) * bit
    }

    // step3 终止计算(概率)：𝑃(𝑂|𝜆)=∑ a(t)(i)
    sum(alphati)
  }


  /**
   * 后向算法
   *
   * @param o 观测序列                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              观测序列
   * @return 产生观测序列的概率
   */
  def backwardAlgorithm(o: DenseVector[Int]) = {

    //   βT(i) = 1, i=1,2,……N
    var betati: DenseVector[Double] = DenseVector(Array.fill(n)(1.0))

    //    βt(i) = ∑ a(i)(j)b(j)(o(t+1))β(t+1)(j)
    for (t <- 1 until o.length reverse) {

      val beat = new ListBuffer[Double]()
      for (i <- 0 until n) {
        val aij = stateTransitionMatrix(i, ::).inner
        val bjT = confusionMatrix(::, o(t))

        beat.append(sum(aij * bjT * betati))
      }
      betati = DenseVector(beat.toArray)
    }

    sum(pi * confusionMatrix(::, o(0)) * betati)

  }
}


object hmm {


  def main(args: Array[String]): Unit = {
    val pi = DenseVector(Array(0.2, 0.4, 0.4)) //pi

    val stateTransitionMatrix = DenseMatrix((0.5, 0.2, 0.3), (0.3, 0.5, 0.2), (0.2, 0.3, 0.5)) //A

    val confusionMatrix = DenseMatrix((0.5, 0.5), (0.4, 0.6), (0.7, 0.3)) //B

    val o = DenseVector(Array(0, 1, 0, 1)) //O

    val hmmModel = hmm(pi, stateTransitionMatrix, confusionMatrix)

    val forward = hmmModel.forwardAlgorithm(o)
    val backward = hmmModel.backwardAlgorithm(o)
    println(forward)
    println(backward)

  }

}